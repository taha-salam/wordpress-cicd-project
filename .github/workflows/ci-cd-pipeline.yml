name: WordPress CI/CD Pipeline

on:
  push:
    branches: 
      - main
      - develop
  pull_request:
    branches: 
      - main
  workflow_dispatch:

env:
  WORDPRESS_URL: http://localhost:8000
  WORDPRESS_USER: admin
  WORDPRESS_PASS: password

jobs:
  source-validation:
    name: Source Stage - Validate Repository
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check Repository Structure
        run: |
          echo "Source Stage: Repository checked out successfully"
          echo "Validating project structure..."
          
          [ -d "tests/backend" ] && echo "tests/backend exists" || echo "tests/backend missing"
          [ -d "tests/frontend" ] && echo "tests/frontend exists" || echo "tests/frontend missing"
          [ -d ".github/workflows" ] && echo ".github/workflows exists" || echo ".github/workflows missing"
          [ -f "docker-compose.yml" ] && echo "docker-compose.yml exists" || echo "docker-compose.yml missing"
          [ -f "requirements.txt" ] && echo "requirements.txt exists" || echo "requirements.txt missing"
          
          echo ""
          echo "Repository Statistics:"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
      
      - name: Source Stage Complete
        run: echo "Source stage validation completed successfully!"

  build:
    name: Build Stage - Setup WordPress
    runs-on: ubuntu-latest
    needs: source-validation
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Start WordPress and MySQL Containers
        run: |
          echo "Starting WordPress environment..."
          docker compose up -d
          echo "Waiting for containers to be healthy..."
          sleep 30
      
      - name: Install and Configure WordPress
        run: |
          echo "Installing WP-CLI..."
          docker compose exec -T wordpress bash -c "
            curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
            chmod +x wp-cli.phar
            mv wp-cli.phar /usr/local/bin/wp
          "
          
          echo "Installing WordPress..."
          docker compose exec -T wordpress wp core install \
            --url='http://localhost:8000' \
            --title='Test Site' \
            --admin_user='Fastians' \
            --admin_password='8Wk5ujnODaxMLKp(wQ' \
            --admin_email='admin@test.com' \
            --skip-email \
            --allow-root
          
          echo "Configuring permalinks..."
          docker compose exec -T wordpress wp rewrite structure '/%postname%/' --allow-root
          docker compose exec -T wordpress wp rewrite flush --allow-root
          
          echo "Enabling mod_rewrite..."
          docker compose exec -T wordpress a2enmod rewrite
          
          echo "Restarting Apache..."
          docker compose restart wordpress
          sleep 10
          
          echo "WordPress configured successfully!"
      
      - name: Install Composer Dependencies (Sentry SDK)
        run: |
          docker compose exec -T wordpress apt-get update && apt-get install -y unzip
          docker compose exec -T wordpress curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
          docker compose exec -T wordpress composer install --no-dev --optimize-autoloader

      - name: Verify WordPress is Running
        run: |
          echo "Testing WordPress..."
          curl -f http://localhost:8000 || exit 1
          curl -f http://localhost:8000/wp-json/ || exit 1
          echo "WordPress is ready!"
      
      - name: Build Stage Complete
        run: echo "Build stage completed successfully!"

  test-backend:
    name: Test Stage - Backend API Testing
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Start WordPress Environment
        run: |
          docker compose up -d
          sleep 40
      
      - name: Install WP-CLI
        run: |
          docker compose exec -T wordpress bash -c "
            curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
            chmod +x wp-cli.phar
            mv wp-cli.phar /usr/local/bin/wp
          "
      
      - name: Configure WordPress
        run: |
          docker compose exec -T wordpress wp core install \
            --url='http://localhost:8000' \
            --title='Test Site' \
            --admin_user='Fastians' \
            --admin_password='8Wk5ujnODaxMLKp(wQ' \
            --admin_email='admin@test.com' \
            --skip-email \
            --allow-root
          
          docker compose exec -T wordpress wp rewrite structure '/%postname%/' --allow-root
          docker compose exec -T wordpress wp rewrite flush --allow-root
          docker compose exec -T wordpress a2enmod rewrite
          docker compose restart wordpress
          sleep 10
      
      - name: Run Backend Integration Tests
        run: |
          echo "Running backend API tests..."
          pytest tests/backend/test_integration.py -v --html=backend-report.html --self-contained-html
      
      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-report
          path: backend-report.html
      
      - name: Backend Tests Complete
        run: echo "Backend testing completed!"

  test-php-unit:
    name: PHP Unit Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli, mbstring, xml
          tools: phpunit:10.5
      
      - name: Run PHP Unit Tests
        run: |
          echo "Running PHPUnit tests..."
          phpunit tests/backend/WordPressBackendUnitTest.php
      
      - name: PHP Unit Tests Complete
        run: echo "PHP unit testing completed!"

  test-frontend-security:
    name: Test Stage - Security Tests (Cypress)
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Cypress Dependencies
        working-directory: tests/frontend
        run: npm install
      
      - name: Start WordPress Environment
        run: |
          docker compose up -d
          sleep 40
      
      - name: Install WP-CLI
        run: |
          docker compose exec -T wordpress bash -c "
            curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
            chmod +x wp-cli.phar
            mv wp-cli.phar /usr/local/bin/wp
          "
      
      - name: Configure WordPress
        run: |
          docker compose exec -T wordpress wp core install \
            --url='http://localhost:8000' \
            --title='Test Site' \
            --admin_user='Fastians' \
            --admin_password='8Wk5ujnODaxMLKp(wQ' \
            --admin_email='admin@test.com' \
            --skip-email \
            --allow-root
          
          docker compose exec -T wordpress wp rewrite structure '/%postname%/' --allow-root
          docker compose exec -T wordpress wp rewrite flush --allow-root
          docker compose exec -T wordpress a2enmod rewrite
          docker compose restart wordpress
          sleep 10
      
      - name: Run Cypress Security Tests
        working-directory: tests/frontend
        run: |
          echo "Running security tests..."
          npx cypress run --spec "cypress/e2e/security_*.cy.js,cypress/e2e/AdditionalSecurityTesting.cy.js" --browser chrome --headless
      
      - name: Upload Cypress Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-security-screenshots
          path: tests/frontend/cypress/screenshots
      
      - name: Upload Cypress Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-security-videos
          path: tests/frontend/cypress/videos
      
      - name: Security Tests Complete
        run: echo "Security testing completed!"

  test-frontend-accessibility:
    name: Test Stage - Accessibility Tests (Cypress)
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Cypress Dependencies
        working-directory: tests/frontend
        run: npm install
      
      - name: Start WordPress Environment
        run: |
          docker compose up -d
          sleep 40
      
      - name: Install WP-CLI
        run: |
          docker compose exec -T wordpress bash -c "
            curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
            chmod +x wp-cli.phar
            mv wp-cli.phar /usr/local/bin/wp
          "
      
      - name: Configure WordPress
        run: |
          docker compose exec -T wordpress wp core install \
            --url='http://localhost:8000' \
            --title='Test Site' \
            --admin_user='Fastians' \
            --admin_password='8Wk5ujnODaxMLKp(wQ' \
            --admin_email='admin@test.com' \
            --skip-email \
            --allow-root
          
          docker compose exec -T wordpress wp rewrite structure '/%postname%/' --allow-root
          docker compose exec -T wordpress wp rewrite flush --allow-root
          docker compose exec -T wordpress a2enmod rewrite
          docker compose restart wordpress
          sleep 10
      
      - name: Run Cypress Accessibility Tests
        working-directory: tests/frontend
        run: |
          echo "Running accessibility tests..."
          npx cypress run --spec "cypress/e2e/accessibility.cy.js" --browser chrome --headless
      
      - name: Upload Cypress Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-accessibility-screenshots
          path: tests/frontend/cypress/screenshots
      
      - name: Upload Cypress Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-accessibility-videos
          path: tests/frontend/cypress/videos
      
      - name: Accessibility Tests Complete
        run: echo "Accessibility testing completed!"

  test-frontend-functional:
    name: Test Stage - Functional Tests (Cypress)
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Cypress Dependencies
        working-directory: tests/frontend
        run: npm install
      
      - name: Start WordPress Environment
        run: |
          docker compose up -d
          sleep 40
      
      - name: Install WP-CLI
        run: |
          docker compose exec -T wordpress bash -c "
            curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
            chmod +x wp-cli.phar
            mv wp-cli.phar /usr/local/bin/wp
          "
      
      - name: Configure WordPress with Test User
        run: |
          docker compose exec -T wordpress wp core install \
            --url='http://localhost:8000' \
            --title='Test Site' \
            --admin_user='Fastians' \
            --admin_password='8Wk5ujnODaxMLKp(wQ' \
            --admin_email='admin@test.com' \
            --skip-email \
            --allow-root
          
          docker compose exec -T wordpress wp rewrite structure '/%postname%/' --allow-root
          docker compose exec -T wordpress wp rewrite flush --allow-root
          docker compose exec -T wordpress a2enmod rewrite
          docker compose restart wordpress
          sleep 10
      
      - name: Run Cypress Functional Tests
        working-directory: tests/frontend
        run: |
          echo "Running functional tests..."
          npx cypress run --spec "cypress/e2e/wordpress-*.cy.js,cypress/e2e/wrodpress-*.cy.js" --browser chrome --headless --config defaultCommandTimeout=10000,pageLoadTimeout=60000
      
      - name: Upload Cypress Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-functional-screenshots
          path: tests/frontend/cypress/screenshots
      
      - name: Upload Cypress Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-functional-videos
          path: tests/frontend/cypress/videos
      
      - name: Functional Tests Complete
        run: echo "Functional testing completed!"

  test-performance-k6:
    name: Test Stage - Performance Tests (K6)
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Install K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: Start WordPress Environment
        run: |
          docker compose up -d
          sleep 40
      
      - name: Install WP-CLI
        run: |
          docker compose exec -T wordpress bash -c "
            curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
            chmod +x wp-cli.phar
            mv wp-cli.phar /usr/local/bin/wp
          "
      
      - name: Configure WordPress
        run: |
          docker compose exec -T wordpress wp core install \
            --url='http://localhost:8000' \
            --title='Test Site' \
            --admin_user='Fastians' \
            --admin_password='8Wk5ujnODaxMLKp(wQ' \
            --admin_email='admin@test.com' \
            --skip-email \
            --allow-root
          
          docker compose exec -T wordpress wp rewrite structure '/%postname%/' --allow-root
          docker compose exec -T wordpress wp rewrite flush --allow-root
          docker compose exec -T wordpress a2enmod rewrite
          docker compose restart wordpress
          sleep 10
      
      - name: Run K6 Performance Tests
        run: |
          echo "Running K6 performance tests..."
          k6 run tests/frontend/k6/performance_test.js
      
      - name: Upload Performance Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-performance-results
          path: performance-summary.json
      
      - name: Performance Tests Complete
        run: echo "Performance testing completed!"

  # =====================================================
  # STAGE 4: REAL ARGO CD DEPLOYMENT (TRIGGERS ACTUAL DEPLOY)
  # =====================================================
  staging-deploy-argocd:
    name: Staging Stage - Deploy to Argo CD (GitOps)
    runs-on: ubuntu-latest
    needs:
      - source-validation
      - build
      - test-backend
      - test-php-unit
      - test-frontend-security
      - test-frontend-accessibility
      - test-frontend-functional
      - test-performance-k6
    if: >-
      ${{ always() &&
          !contains(needs.*.result, 'failure') &&
          !contains(needs.*.result, 'cancelled') &&
          github.ref == 'refs/heads/main' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false   # prevents using the default GITHUB_TOKEN

      - name: Configure Git to use PAT (allows push to main)
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git

      - name: Create/Update Deployment Trigger Manifest
        run: |
          mkdir -p deploy/staging
          
          cat > deploy/staging/wordpress-deployment-trigger.yaml << EOF
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: wordpress-deploy-trigger
            namespace: wordpress-staging
            labels:
              app.kubernetes.io/name: wordpress
              app.kubernetes.io/instance: staging
              deploy-time: "$(date -u +%Y%m%d-%H%M%S)"
          data:
            deployedAt: "$(date -u +"%Y-%m-%d %H:%M:%SZ")"
            commit: "${{ github.sha }}"
            commitShort: "${{ github.sha_short }}"
            branch: "main"
            triggeredBy: "${{ github.actor }}"
            runId: "${{ github.run_id }}"
            runNumber: "${{ github.run_number }}"
            pipelineUrl: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          EOF

          echo "Created/updated deploy/staging/wordpress-deployment-trigger.yaml"
          cat deploy/staging/wordpress-deployment-trigger.yaml

      - name: Commit & Push to Trigger Argo CD Sync
        run: |
          git add deploy/staging/wordpress-deployment-trigger.yaml
          
          git commit -m "chore: trigger staging deployment via Argo CD [skip ci]

          All tests passed
          Commit: ${{ github.sha }}
          Run: #${{ github.run_number }}" || echo "No changes to commit"
          
          git push --force-with-lease origin main
          
          echo "Pushed manifest â†’ Argo CD will now auto-sync and deploy!"

      - name: Success Message
        run: |
          echo "STAGING DEPLOYMENT SUCCESSFULLY TRIGGERED!"
          echo "Argo CD is syncing wordpress-staging application"
          echo "Check status: https://localhost:8080/applications/wordpress-staging (after port-forward)"

  sentry-release:
    name: Sentry Release and Monitoring
    runs-on: ubuntu-latest
    needs: staging-deploy-argocd
    if: github.ref == 'refs/heads/main' && needs.staging-deploy-argocd.result == 'success'
    env:
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      SENTRY_ORG: ${{ secrets.SENTRY_ORG }}  # Your org slug
      SENTRY_PROJECT_PHP: wordpress-backend
      SENTRY_PROJECT_JS: wordpress-frontend
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create Sentry Release (PHP Backend)
        uses: getsentry/action-release@v1
        with:
          environment: staging
          set_commits: auto
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ env.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ env.SENTRY_PROJECT_PHP }}
      
      - name: Create Sentry Release (JS Frontend)
        uses: getsentry/action-release@v1
        with:
          environment: staging
          set_commits: auto
          sourcemaps: ./wp-content/themes/**/*.js  # Adjust if no sourcemaps
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ env.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ env.SENTRY_PROJECT_JS }}

  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: 
      - source-validation
      - build
      - test-backend
      - test-php-unit
      - test-frontend-security
      - test-frontend-accessibility
      - test-frontend-functional
      - test-performance-k6
      - staging-deploy-argocd
    if: always()
    
    steps:
      - name: Display Pipeline Results
        run: |
          echo "================================"
          echo "   CI/CD PIPELINE SUMMARY"
          echo "================================"
          echo ""
          echo "Source Stage: ${{ needs.source-validation.result }}"
          echo "Build Stage: ${{ needs.build.result }}"
          echo "Test Stage (Backend): ${{ needs.test-backend.result }}"
          echo "Test Stage (PHP Unit): ${{ needs.test-php-unit.result }}"
          echo "Test Stage (Security): ${{ needs.test-frontend-security.result }}"
          echo "Test Stage (Accessibility): ${{ needs.test-frontend-accessibility.result }}"
          echo "Test Stage (Functional): ${{ needs.test-frontend-functional.result }}"
          echo "Test Stage (Performance): ${{ needs.test-performance-k6.result }}"
          echo "Staging Deploy: ${{ needs.staging-deploy-argocd.result }}"
          echo ""
          echo "Pipeline completed at: $(date)"