name: WordPress CI/CD Pipeline

# ============================================
# WEBHOOK TRIGGERS (Source Stage)
# ============================================
on:
  push:
    branches: 
      - main
      - develop
  pull_request:
    branches: 
      - main
  workflow_dispatch:  # Manual trigger option

# ============================================
# ENVIRONMENT VARIABLES
# ============================================
env:
  WORDPRESS_URL: http://localhost:8000
  WORDPRESS_USER: admin
  WORDPRESS_PASS: password

jobs:
  # ============================================
  # JOB 1: SOURCE STAGE VALIDATION
  # ============================================
  source-validation:
    name: ğŸ” Source Stage - Validate Repository
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: ğŸ” Check Repository Structure
        run: |
          echo "âœ… Source Stage: Repository checked out successfully"
          echo "ğŸ“ Validating project structure..."
          
          # Check required directories exist
          [ -d "tests/backend" ] && echo "âœ… tests/backend exists" || echo "âŒ tests/backend missing"
          [ -d ".github/workflows" ] && echo "âœ… .github/workflows exists" || echo "âŒ .github/workflows missing"
          [ -f "docker-compose.yml" ] && echo "âœ… docker-compose.yml exists" || echo "âŒ docker-compose.yml missing"
          [ -f "requirements.txt" ] && echo "âœ… requirements.txt exists" || echo "âŒ requirements.txt missing"
          
          echo ""
          echo "ğŸ“Š Repository Statistics:"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
      
      - name: ğŸ“‹ List Changed Files
        if: github.event_name == 'push'
        run: |
          echo "ğŸ“ Files changed in this push:"
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} || echo "Initial commit"
      
      - name: âœ… Source Stage Complete
        run: |
          echo "ğŸ‰ Source stage validation completed successfully!"
          echo "Pipeline will now proceed to Build stage..."

  # ============================================
  # JOB 2: BUILD STAGE (Next stage placeholder)
  # ============================================
  build:
    name: ğŸ—ï¸ Build Stage - Setup WordPress
    runs-on: ubuntu-latest
    needs: source-validation
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ“¦ Start WordPress & MySQL Containers
        run: |
          echo "ğŸš€ Starting WordPress environment..."
          docker-compose up -d
          echo "â³ Waiting for WordPress to initialize..."
          sleep 50
      
      - name: âœ… Verify WordPress is Running
        run: |
          echo "ğŸ” Testing WordPress availability..."
          curl -f http://localhost:8000 || (echo "âŒ WordPress not reachable" && exit 1)
          echo "âœ… WordPress is running!"
          
          echo "ğŸ” Testing REST API..."
          curl -f http://localhost:8000/wp-json/ || (echo "âŒ REST API not reachable" && exit 1)
          echo "âœ… REST API is accessible!"
      
      - name: âœ… Build Stage Complete
        run: |
          echo "ğŸ‰ Build stage completed successfully!"

  # ============================================
  # JOB 3: TEST STAGE (Backend - Your Part)
  # ============================================
  test-backend:
    name: ğŸ§ª Test Stage - Backend API Testing
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: ğŸ“¦ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ³ Start WordPress Environment
        run: |
          docker-compose up -d
          sleep 50
      
      - name: âš™ï¸ Configure WordPress
        run: |
          # Install WP-CLI in container
          docker-compose exec -T wordpress bash -c "
            curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
            chmod +x wp-cli.phar
            mv wp-cli.phar /usr/local/bin/wp
          "
          
          # Install WordPress
          docker-compose exec -T wordpress wp core install \
            --url='http://localhost:8000' \
            --title='Test Site' \
            --admin_user='admin' \
            --admin_password='password' \
            --admin_email='admin@test.com' \
            --skip-email \
            --allow-root || echo "WordPress already installed"
      
      - name: ğŸ§ª Run Backend Integration Tests
        run: |
          echo "ğŸš€ Running backend API tests..."
          pytest tests/backend/test_integration.py -v --html=backend-report.html --self-contained-html
      
      - name: ğŸ“Š Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-report
          path: backend-report.html
      
      - name: âœ… Backend Tests Complete
        run: |
          echo "ğŸ‰ Backend testing completed!"

  # ============================================
  # SUMMARY JOB
  # ============================================
  pipeline-summary:
    name: ğŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [source-validation, build, test-backend]
    if: always()
    
    steps:
      - name: ğŸ“Š Display Pipeline Results
        run: |
          echo "================================"
          echo "   CI/CD PIPELINE SUMMARY"
          echo "================================"
          echo ""
          echo "âœ… Source Stage: ${{ needs.source-validation.result }}"
          echo "âœ… Build Stage: ${{ needs.build.result }}"
          echo "âœ… Test Stage (Backend): ${{ needs.test-backend.result }}"
          echo ""
          echo "Pipeline completed at: $(date)"
