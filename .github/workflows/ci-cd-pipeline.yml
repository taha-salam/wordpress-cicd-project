name: WordPress CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  WORDPRESS_URL: http://localhost:8000
  WORDPRESS_USER: admin
  WORDPRESS_PASS: password

jobs:
  source-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate structure
        run: |
          echo "Checking required files..."
          ls -la docker-compose.yml requirements.txt tests/backend/ || exit 1

  build:
    needs: source-validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Start containers
        run: docker compose up -d

      - name: Wait for MySQL to be healthy
        run: |
          echo "Waiting for MySQL to become healthy..."
          for i in $(seq 1 60); do
            if docker compose ps db | grep "(healthy)" > /dev/null; then
              echo "MySQL is healthy!"
              break
            fi
            echo "Waiting... ($i/60)"
            sleep 3
          done
          docker compose ps

      - name: Install WP-CLI
        run: |
          docker compose exec -T wordpress bash -c "
            curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar && \
            chmod +x wp-cli.phar && \
            mv wp-cli.phar /usr/local/bin/wp
          "

      - name: Install WordPress
        run: |
          docker compose exec -T wordpress wp core install \
            --url=http://localhost:8000 \
            --title="Test Site" \
            --admin_user=admin \
            --admin_password=password \
            --admin_email=admin@example.com \
            --skip-email \
            --allow-root

      - name: Configure permalinks & Apache
        run: |
          docker compose exec -T wordpress wp rewrite structure '/%postname%/' --allow-root
          docker compose exec -T wordpress wp rewrite flush --allow-root
          docker compose exec -T wordpress a2enmod rewrite
          docker compose exec -T wordpress apache2ctl graceful

      - name: Verify site & REST API
        run: |
          sleep 8
          curl -f http://localhost:8000 || exit 1
          curl -f http://localhost:8000/wp-json/ | head -20
          echo "WordPress + REST API are working!"

  test-backend:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start containers
        run: docker compose up -d

      - name: Wait for MySQL
        run: |
          for i in $(seq 1 60); do docker compose ps db | grep healthy && break; echo "Waiting... ($i)"; sleep 3; done

      - name: Install WP-CLI
        run: |
          docker compose exec -T wordpress bash -c "
            [ -f /usr/local/bin/wp ] || (
              curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar && \
              chmod +x wp-cli.phar && \
              mv wp-cli.phar /usr/local/bin/wp
            )
          "

      - name: Install & configure WordPress
        run: |
          docker compose exec -T wordpress wp core install \
            --url=http://localhost:8000 \
            --title="Test Site" \
            --admin_user=admin \
            --admin_password=password \
            --admin_email=admin@example.com \
            --skip-email \
            --allow-root || true

          docker compose exec -T wordpress wp rewrite structure '/%postname%/' --allow-root
          docker compose exec -T wordpress wp rewrite flush --allow-root
          docker compose exec -T wordpress a2enmod rewrite
          docker compose exec -T wordpress apache2ctl graceful
          sleep 8

      - name: Run integration tests
        run: |
          pytest tests/backend/test_integration.py -v --html=report.html --self-contained-html

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-report
          path: report.html

  test-php-unit:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli, mbstring, xml, intl, gd
          tools: composer

      - name: Composer install
        run: |
          if [ -f composer.json ]; then
            composer install --no-progress --prefer-dist
          fi

      - name: Run PHPUnit
        run: |
          if [ -f vendor/autoload.php ]; then
            phpunit --bootstrap vendor/autoload.php tests/backend/WordPressBackendUnitTest.php
          else
            phpunit tests/backend/WordPressBackendUnitTest.php
          fi

  summary:
    needs: [build, test-backend, test-php-unit]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Final result
        run: |
          echo "Build: ${{ needs.build.result }}"
          echo "Backend Tests: ${{ needs.test-backend.result }}"
          echo "PHP Unit: ${{ needs.test-php-unit.result }}"
          if [[ "${{ needs.build.result }}" == "success" && \
                "${{ needs.test-backend.result }}" == "success" && \
                "${{ needs.test-php-unit.result }}" == "success" ]]; then
            echo "PIPELINE PASSED"
          else
            echo "PIPELINE FAILED"
            exit 1
          fi